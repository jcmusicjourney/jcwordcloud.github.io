<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文字雲｜張學友的形容詞（首屏顯示＋每5分鐘更新）</title>
  <meta name="description" content="載入即顯示文字雲；提交不即時更新；每5分鐘自動從 Firebase 讀取並重繪。" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#ffffff; --card:#ffffff; --border:#e5e7eb; --accent:#1a73e8; --text:#0f172a; --muted:#475569; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; padding:0; font-family:'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "微軟正黑體", "PingFang TC", sans-serif; background:var(--bg); color:var(--text); }
    header { padding:28px 20px 8px; text-align:center; }
    h1 { margin:0; font-size:28px; letter-spacing:0.4px; }
    p.sub { margin:8px 0 16px; color:var(--muted); font-size:14px; }
    .container { max-width:980px; margin:0 auto; padding:10px 16px 32px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .row { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:880px) { .row { grid-template-columns:420px 1fr; } }
    .prompt { padding:14px; border-radius:12px; background:#fff; border:1px dashed var(--border); }
    .prompt label { display:block; margin-bottom:6px; font-weight:700; }
    .input-wrap { display:flex; gap:10px; align-items:center; }
    input[type=text]{ flex:1; padding:12px 14px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; color:var(--text); outline:none; font-size:15px; transition:border-color .2s ease; }
    input[type=text]:focus{ border-color:var(--accent); }
    .btn { padding:10px 14px; border-radius:10px; border:1px solid #cbd5e1; background:#f8fafc; color:var(--text); cursor:pointer; font-size:14px; font-weight:600; transition:all .2s ease; }
    .btn.primary { background:linear-gradient(180deg, #1a73e8 0%, #0f62d0 100%); border-color:#0f62d0; color:#fff; }
    .btn.secondary { background:#fff; }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.03); }
    .hint{ font-size:12px; color:var(--muted); margin-top:8px; }
    .stats{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px; }
    .badge{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:12px; color:var(--muted); }
    .badge strong{ color:var(--text); }
    .cloud-wrap{ position:relative; min-height:420px; background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    #cloud{ width:100%; height:100%; }
    .top-list { background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; }
    .top-list h3 { margin:0 0 8px; font-size:16px; }
    .top-list ol{ margin:0; padding-left:18px; }
    .top-list li{ padding:4px 0; color:var(--muted); }
    .top-list li strong{ color:var(--text); }
    footer{ text-align:center; font-size:12px; color:var(--muted); padding:16px 0 26px; }
    code.inline{ background:#f1f5f9; border:1px solid var(--border); padding:2px 6px; border-radius:6px; }
  </style>
  <!-- ✅ 改為使用 defer 的全域腳本（可靠）：先載 d3 / d3-cloud，再執行下方 App 腳本 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js" defer></script>
</head>
<body>
  <header>
    <h1>說起「張學友」，你會想到甚麼形容詞？</h1>
    <p class="sub">載入即顯示文字雲；提交後不即時更新；每 5 分鐘自動更新一次。</p>
  </header>
  <div class="container">
    <div class="row">
      <div class="card">
        <div class="prompt">
          <label for="answer">請輸入你的答案：</label>
          <div class="input-wrap">
            <input id="answer" type="text" placeholder="例如：溫柔、專業、細膩、動人" autocomplete="off"/>
            <button class="btn primary" id="submitBtn">確定</button>
            <button class="btn secondary" id="clearBtn" title="只清除本機資料（不會清除即時房間）">清空</button>
          </div>
          <div class="hint">提示：支援分隔符號 <code class="inline">空格</code>、<code class="inline">,</code>、<code class="inline">，</code>、<code class="inline">；</code>、<code class="inline">;</code>、<code class="inline">、</code>。</div>
          <button class="btn secondary" id="refreshBtn" style="margin-top:10px">手動更新文字雲</button>
        </div>
        <div class="stats">
          <div class="badge">提交次數：<strong id="totalSubmits">0</strong></div>
          <div class="badge">唯一詞彙：<strong id="uniqueWords">0</strong></div>
        </div>
        <div class="top-list" style="margin-top:12px;">
          <h3>熱門形容詞 TOP 10</h3>
          <ol id="topList"></ol>
        </div>
      </div>
      <div class="card cloud-wrap">
        <svg id="cloud" viewBox="0 0 640 420" preserveAspectRatio="xMidYMid meet"></svg>
      </div>
    </div>
  </div>
  <footer>
    <div>© 2025 文字雲遊戲 · 非即時渲染 · 每5分鐘更新 · Firebase v12</div>
  </footer>

  <!-- App 腳本（依賴上面的 d3 / d3-cloud 已 defer 載入，DOM Ready 後再執行） -->
  <script>
    const ROOM_ID = 'jacky-cheung-adjectives';

    const splitTokens = (input) => {
      if (!input) return [];
      return input.replace(/[\n\r]+/g,' ').split(/[\s,，；;、]+/).map(t=>t.trim()).filter(t=>t.length>0).map(t=>t.replace(/\u3000/g,' '));
    };
    const normalize = (w) => { const full2half=(s)=>s.replace(/[\uff01-\uff5e]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)); return full2half(w).toLowerCase(); };

    window.state = { counts:new Map(), totalSubmits:0, realtime:false, db:null, wordsRef:null };

    const saveLocal = () => { const obj=Object.fromEntries(state.counts); localStorage.setItem('wc_counts', JSON.stringify(obj)); localStorage.setItem('wc_total', String(state.totalSubmits)); };
    const loadLocal = () => { try{ const raw=localStorage.getItem('wc_counts'); const total=parseInt(localStorage.getItem('wc_total')||'0',10); if(raw){ const obj=JSON.parse(raw); state.counts = new Map(Object.entries(obj)); } state.totalSubmits=isNaN(total)?0:total; }catch(e){} };

    const width=640, height=420; const svgEl=document.getElementById('cloud');
    let renderQueued=false;
    function scheduleRender(){ if(renderQueued) return; renderQueued=true; setTimeout(()=>{ renderQueued=false; window.renderCloud(); },300); }

    window.renderCloud = () => {
      const d3 = window.d3; // 來自全域
      const current=Array.from(state.counts.entries()).map(([word,count])=>({text:word,size:count}));
      const sel=d3.select(svgEl); sel.selectAll('*').remove();
      if(current.length===0){ d3.select(svgEl).append('text').attr('x',width/2).attr('y',height/2).attr('text-anchor','middle').attr('fill','#94a3b8').style('font-size','16px').text('還沒有資料，先在左側輸入形容詞吧！'); return; }
      const max=d3.max(current,d=>d.size)||1, min=d3.min(current,d=>d.size)||1; const fontScale=d3.scaleLinear().domain([min,max]).range([16,90]);
      const layout=d3.layout.cloud().size([width,height]).words(current.map(d=>({text:d.text,size:fontScale(d.size)}))).padding(3).rotate(()=> (Math.random()<0.85?0:90)).spiral('archimedean').font('Noto Sans TC').fontSize(d=>d.size).on('end',(words)=>{
        const g=d3.select(svgEl).append('g').attr('transform',`translate(${width/2},${height/2})`);
        g.selectAll('text').data(words).enter().append('text').style('font-size',d=>`${d.size}px`).style('font-family','Noto Sans TC, system-ui').style('fill',()=> d3.interpolateTurbo(Math.random()*0.8+0.1)).attr('text-anchor','middle').attr('transform',d=>`translate(${d.x},${d.y})rotate(${d.rotate})`).text(d=>d.text).append('title').text(d=>d.text);
      });
      layout.start();
    };
    window.requestCloudRender = () => scheduleRender();

    window.renderStats = () => {
      document.getElementById('totalSubmits').textContent=String(state.totalSubmits);
      document.getElementById('uniqueWords').textContent=String(state.counts.size);
      const top=Array.from(state.counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10); const ol=document.getElementById('topList'); ol.innerHTML='';
      top.forEach(([w,c])=>{ const li=document.createElement('li'); li.innerHTML=`<strong>${w}</strong> — ${c}`; ol.appendChild(li); });
    };

    const DEFAULT_BOOTSTRAP = { '唱歌':5, '歌神':8 };

    const submit = (raw) => {
      const tokens=splitTokens(raw); if(tokens.length===0) return; state.totalSubmits += 1; tokens.forEach(w=>{ const key=normalize(w); const cur=state.counts.get(key)||0; state.counts.set(key,cur+1); });
      if (state.realtime && state.wordsRef && typeof window.firebasePushWord==='function'){ tokens.forEach(w=> window.firebasePushWord(normalize(w))); }
      saveLocal(); requestCloudRender(); renderStats(); if (typeof window.lazyLoadAnalytics==='function') window.lazyLoadAnalytics();
    };

    const clearLocal = () => { localStorage.removeItem('wc_counts'); localStorage.removeItem('wc_total'); state.counts=new Map(); state.totalSubmits=0; requestCloudRender(); renderStats(); };

    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('submitBtn').addEventListener('click', ()=>{ const v=document.getElementById('answer').value.trim(); submit(v); document.getElementById('answer').value=''; document.getElementById('answer').focus(); });
      document.getElementById('answer').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('submitBtn').click(); }});
      document.getElementById('clearBtn').addEventListener('click', clearLocal);
      document.getElementById('refreshBtn').addEventListener('click', ()=>{ if (typeof window.loadOnceFromFirebase==='function') window.loadOnceFromFirebase(); });

      loadLocal();
      if (state.counts.size===0){ Object.entries(DEFAULT_BOOTSTRAP).forEach(([w,c])=> state.counts.set(w,c)); }
      renderCloud(); renderStats();
    });
  </script>

  <!-- Firebase v12 模組：非即時渲染；首次在 DOM Ready 後抓取；每5分鐘自動更新 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDO429O2JfwCLLveTPsg9eR2NZKdOKjPdA",
      authDomain: "jcwordcloud.firebaseapp.com",
      databaseURL: "https://jcwordcloud-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "jcwordcloud",
      storageBucket: "jcwordcloud.firebasestorage.app",
      messagingSenderId: "585386416126",
      appId: "1:585386416126:web:5eda0b9228daad218dd2af",
      measurementId: "G-S8KMDFZ7NP"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.lazyLoadAnalytics = async () => {
      if (window.__analyticsLoaded) return; window.__analyticsLoaded = true;
      try { const { getAnalytics } = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js'); getAnalytics(app); } catch(e){}
    };

    const roomId = typeof ROOM_ID !== 'undefined' ? ROOM_ID : 'jacky-cheung-adjectives';
    const wordsRef = ref(db, `rooms/${roomId}/words`);
    window.state.realtime = true; window.state.db = db; window.state.wordsRef = wordsRef;

    async function loadOnceFromFirebase(){
      try{
        const snap = await get(wordsRef); const raw = snap.val() || {};
        const temp = new Map();
        Object.values(raw).forEach(rec=>{ if(rec && rec.word){ const w=rec.word; temp.set(w,(temp.get(w)||0)+1); } });
        if (temp.size===0 && window.state.counts.size===0 && typeof DEFAULT_BOOTSTRAP!=='undefined'){
          Object.entries(DEFAULT_BOOTSTRAP).forEach(([w,c])=> temp.set(w,c));
        }
        window.state.counts = temp; window.requestCloudRender(); window.renderStats();
      }catch(e){
        console.warn('Firebase get() error, use defaults/local:', e);
        if (window.state.counts.size===0 && typeof DEFAULT_BOOTSTRAP!=='undefined'){
          Object.entries(DEFAULT_BOOTSTRAP).forEach(([w,c])=> window.state.counts.set(w,c));
        }
        window.requestCloudRender(); window.renderStats();
      }
    }
    window.loadOnceFromFirebase = loadOnceFromFirebase;

    // ✅ DOM Ready 後再首次抓取（避免首屏空白）
    document.addEventListener('DOMContentLoaded', () => {
      loadOnceFromFirebase();
    });

    // ⏱ 每 5 分鐘自動更新（可見時才拉）
    const FIVE_MIN = 300000;
    setInterval(()=>{ if(document.visibilityState==='visible'){ loadOnceFromFirebase(); } }, FIVE_MIN);
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ loadOnceFromFirebase(); } });

    // 保留寫入：提交時 push，但不即時重繪
    window.firebasePushWord = (normalizedWord) => { try { push(wordsRef, { word: normalizedWord, ts: Date.now() }); } catch(e){} };
  </script>
</body>
</html>
